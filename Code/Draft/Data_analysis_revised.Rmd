---
title: "Data_Analysis"
output: html_notebook
---

# Overview
For the data analysis phase of this project, there are three main hypotheses that I want to look at:

  1.	Hypothesis: I would like to see if there is a difference in propulsion between the active and passive prostheses.  Since the active prosthetic is designed to mimic the natural motion of the body, I believe the active prosthetic (BiOM) will have more propulsion while walking uphill than the passive prosthetic(ESR). 
  
  2.	Hypothesis: I'd like to investigate whether there is a difference in the dampening effect between the two types of prosthetic legs and/or the intact leg. When walking downhill, the body absorbs force by dampening each step.  This allows humans to maintain a reasonable center of gravity while reducing the forces on other joints.  The active prosthetic is designed to increase energy return upon stepping up whereas the passive ankle is designed to absorb energy and transfer it forward.  While the energy that is transferred forward may not be as strong as in the active prosthetic, I expect the dampening effect of the passive prosthetic to be greater than the active prosthetic. 
  
  3.	Hypothesis: The last thing that I plan to look at is how gait phase impacts power generation.  Power generation refers to the amount of force that is used to push off of the ground.  In different stances, different muscles are involved in power generation which causes this force to vary.  I want to see which stance has the greatest impact on overall power generation.  The three stances I will analyze are the pre-swing, the midstance, and the terminal stance.  Of these, I believe that there will be a significant difference in the power generation associated with the different phases as different gait phases are designed to propel your body forward in different ways.  Physiologically, the body does this by strategically applying force into the ground to help humans and animals to maintain their balance.
  
```{r}
# clear R's environment
rm(list = ls())

# import the modules that we need
library(dplyr)
library(ggplot2)
library(tidyr)
library(ggfortify)
library(here)
```

Import the data that we proceesed during the data processing phase:
```{r}
DF <- read.csv(here("Data", "Processed", "processed_prosthetic_analysis.csv"))
```

# Data Analysis
Since the data is now in the program, we are going to start taking a look at the different statistical tests that will provide more insight into the relationships between these variables.

## Comparing Propulsion between Prosthetic Types
To compare how the propulsion generated by the active prosthetic compares to the propulsion generated by the passive prosthetic I will use a Two-sample T test. From the data exploration, it appears that there is a difference in the spread of the distribution between the two different types of prosthetic and the magnitude of the propulsion that they are able to generate.  

```{r}
# make a histogram of the propulsion based on prosthetic type
ggplot(filter(DF, Side == "Prosthetic"), aes(x = Propulsion))+
    geom_histogram(binwidth = 0.25)+
    facet_wrap(~Session)
```

Based on these histograms, I do not think that there will be a significant difference between the two.  Although it looks like the mean of the active prosthetic may be slightly higher than the passive prosthetic, the range of data is still pretty similar between the two.

To do this, I will perform a two sample T test between the two prosthetic types.  

```{r}
# separate the prosthetic data from the data corresponding to the intact leg data.
DF_prosthetic <- DF %>% filter(Side == "Prosthetic")

# take a look to check the structure of the new data frame
glimpse(DF_prosthetic)
```

```{r}
# perform two sample t test
t.test(Propulsion ~ Session, data = DF_prosthetic)
```
The results of the test show that there is no significant difference between the propulsion generated by the active and passive prostheses (p = 0.0125). Let's graph a scatter plot to show the distribution of the propulsion separated by prosthetic type.
```{r}
# calculate the means propulsion values
meanpropDF<-DF_prosthetic %>% group_by(Session) %>% summarise(
     meanProp = mean(Propulsion))

# make a scatter plot comparing the distribution of propulsion values between the active and passive prostheses
propscatter <- ggplot(DF_prosthetic, aes(Session, Propulsion, colour = Session), size = 3, alpha = 0.5)+
  xlab("Type of Prosthetic")+
  ylab("Propulsion (J/Kg)")+
  geom_jitter(width = 0.1)+
  theme_bw()+
  theme(legend.position="none")

propscatter

propscatter+
geom_point(meanpropDF, mapping = aes(Session, meanProp), size = 4, alpha = 1)
```


## Comparing Dampening Between Prosthetic Types and The Intact Leg
To make this comparison, I am going to perform a two-way ANOVA. The goal is to compare the dampening performance between prostheses and intact legs and see if the type of prosthetic has an effect on dampening performance.

The way you have described this analysis is as though it is a one-way with 3 levels for the treatment: BioM, ESR, intact leg.

In fact, as a two way, you are comparing how dampening is impacted by prothestic type and whether dampening depends on the leg side. Just word it more precisely.

```{r}
# convert the Session and the Side categories to factor data and take a look at the variables
DF$Session <- as.factor(DF$Session)
DF$Side <- as.factor(DF$Side)

levels(DF$Session)
levels(DF$Side)
```

Now, lets take a look at the means of the combinations of each of these.  To do this, we will be using the `group_by()` and `summarize()` functions. 

```{r}
meanDF <- DF %>% group_by(Side, Session) %>% summarise(meanDampening = mean(Braking))
```
With the means calculated, we can now plot the relationships between the different types of legs and prostheses.

```{r}
# Add color to the plot to show the differences between the different types of prostheses compared to the intact leg
ggplot(meanDF, aes(Side, meanDampening, color = Session, group = Session))+
     geom_point()+
     geom_line()+
     theme_bw()+
     ylab("Mean Dampening (J/Kg)")+
     xlab("Type of Leg")
```
Since the lines do not appear to be parallel, it suggests that the prosthetic type may impact dampening of the prosthetic leg as well as the intact leg.  Based on how these slopes are very distinctly positive and negative, I do think that the difference in dampening between the prosthetic types will be significant. 

Compared to the different types of prosthetic legs, the intact leg dampening values are much closer together.  Because of this, I don't think that there will be a significant different between the dampening of the intact legs.  Performing a two way ANOVA will give us more insight on this. 

```{r}
# use the lm() function to create the model
model_dampening <- lm(Braking ~ Session+Side+Session*Side, data = DF)
```

Now check the assumptions using the `autoplot()` function.

```{r}
autoplot(model_dampening, smooth.color = NA)
```
The first thing that we are going to look at is the Residuals vs Fitted graph.  Here, we are looking for the residuals to be distributed away from the curve at relatively equal distances.  From the graph generated using the `autoplot()` function, this appears to be the case.

The next thing that we are looking for is to see if the points fall along the linear model for the Normal Q-Q graph.  Here, it looks like they do which means that the data do fit a normalized distribution.


```{r}
# generate ANOVA table
anova(model_dampening)
```
Based on this ANOVA table it looks like there is not a significant difference between the sides (intact vs prosthetic) but there is a significant difference in session which refers to the type of prosthetic used (BiOM vs ESR).  When the side and the types of prostheses are compared together however, there is not a significant difference between them (p = 0.3539).  

This means that the type of prosthetic is more important when investigating the amount of force absorbed by the individual. In both cases, the differences in dampening by the intact leg is insignificant so in the future, researchers should focus on determining different ways to improve dampening within the prosthetic.  Improving the dampening effects of the prosthetic would reduce the force sent into the residual limb and help mitigate the incidences of overuse injuries in the future. 

```{r}
# take a look at the summary and comparisons between the specific conditions
summary.lm(model_dampening)
```
The results of this summary show that the slopes between these two comparisons are not large enough to warrant a significant difference between the dampening effects of the different types of prosthetic models on the dampening of the intact leg.  This  further supports the analysis motivating additional research into dampening for different prosthetic leg models. 

```{r}
# grab the standard error values to report

sumDF<-DF %>% group_by(Side, Session) %>% summarise(
     meanDamp = mean(Braking),
     seDamp = sd(Braking)/sqrt(sum(!is.na(Braking)))
)

# create scatterplot with error bars
ggplot(sumDF, aes(Side, meanDamp, color = Session, group = Session))+
     geom_point()+
     geom_line()+
     geom_errorbar(aes(ymin = meanDamp - seDamp,
                       ymax = meanDamp + seDamp), width = 0.1)+
     theme_bw()+
    xlab("Type of Leg")+
    ylab("Mean Dampening (J/Kg)")+
    annotate("text", x = 2.4 , y = -0.22,
    label = "n = 12")
```
This figure shows how the error in the measurements for the dampening with the intact leg under both of the different types of prostheses overlaps which supports the results of the two-way ANOVA findings.  Between the two different Prosthetic conditions, the sample sizes are the same so the overlapping error bars as observed in the "intact" condition indicate that the p-value is much greater than 0.05. In contrast, since the error bars for the prosthetic models do not overlap but since the error bars refer to standard error, we cannot draw a direct conclusion from this.

However, we do know from the two-way ANOVA that there is a statistically significant difference between the two prosthetic models so we can use that information to complete the analysis. 


## Comparing the Power Generated in Different Stance Phases
The last hypothesis I will investigate is the power generated in different phases of the stance.  To do this, I will perform a repeated measures ANOVA test.

```{r}
# convert the data to long format
DF_long <- pivot_longer(DF, names_to = "Phase", cols = Power_Gen_Pre:Power_Gen_Terminal,  values_to = "Power")

# convert the phase data from character data to factor data
DF_long$Phase <- as.factor(DF_long$Phase)
levels(DF_long$Phase)

# relevel the Phase factor to put the levels in the correct order which should be midstance, terminalstance, preswing
DF_long$Phase <- factor(DF_long$Phase, levels=c('Power_Gen_Mid', 'Power_Gen_Terminal', 'Power_Gen_Pre'))
```

Generate a boxplot of the data to take a look at the initial relationships between these variables. 

```{r}
# make a boxplot of the data
ggplot(DF_long, aes(Phase, Power)) +
  geom_boxplot()+
  geom_point(size = 3, colour = 'lightgrey', alpha = 0.5)
```
The spread of the boxplot suggests that there is a difference between the power generated during different gait phases. 


This plot also suggests that R is not recognizing that Phase is an ordered factor (pre comes before mid before terminal). If it did, it would plot the boxes in that order.

Here's how we can check:
```{r}
is.ordered(DF_long$Phase)
```
So we should make it ordered:
```{r}
levels(DF_long$Phase) #check the order of the levels before ordering

DF_long$Phase<-factor(DF_long$Phase, 
                      levels = c("Power_Gen_Pre", "Power_Gen_Mid", "Power_Gen_Terminal"),
                      ordered = TRUE)

is.ordered(DF_long$Phase)
```
Now lets make a histogram and facet it by phase to look at these in the correct order:

```{r}
# make a histogram of the power generated separated by phase
ggplot(DF_long, aes(x = Power))+
    geom_histogram(binwidth = 0.25)+
    facet_wrap(~Phase)
```
Based on these histograms, it looks like the data is all relatively normally distributed.  If anything, the power generated in the terminal phase may be slightly left skewed but from the box plot it looks like the mean is in the center of the data so we will proceed with the repeated measures ANOVA analysis.

```{r}
# Use the aov() function to generate a repeated ANOVA model
power_model <- aov(Power~Phase, data = DF_long)

power_model2 <- glm(Power~Phase, data = DF_long)
```

Check the assumptions to ensure this model is a good way to represent this data. 
```{r}
# check assumptions
autoplot(power_model, smooth.color = NA)

autoplot(power_model2, smooth.color = NA)
```
The assumptions look good.  The residuals are evenly distributed from the line and the points fit a normalized distribution of the data as shown by the Normal Q-Q line.

The points don't look too good to me. They are good in the middle of the distribution, but not at the tails. It probably doesn't matter, but we might want to try a glm here.

```{r}
# run a summary of the model
summary(power_model)
```

For repeated measures of variance, the null hypothesis states that the means for each of the groups is equal.  However, the p-value for this test indicates there is a significant difference between the different gait phases.

Let's replot this in a way that shows the relationships between the means better.  

```{r include=FALSE}
# calculate the means and standard errors of these by group

sum_power <-DF_long %>% group_by(Phase) %>% summarise(
     meanPower = mean(Power),
     sePower = sd(Power)/sqrt(sum(!is.na(Power)))
)

# reassign the values of the different gait phases to make them show up nicer on the graph
sum_power$Phase <- recode(sum_power$Phase, Power_Gen_Mid = 'Midstance', 
                                       Power_Gen_Terminal = 'Terminal Stance',
                                       Power_Gen_Pre = 'Preswing')
```

Create a graph summarizing these results:
```{r}
# create scatterplot with error bars
ggplot(sum_power, aes(Phase, meanPower, color = Phase))+
     geom_point()+
     scale_color_manual(values = c("Midstance" = "Magenta",
                                "Terminal Stance" = "Blue",
                                "Preswing"="Dark Green"))+
     geom_line()+
     geom_errorbar(aes(ymin = meanPower - sePower,
                       ymax = meanPower + sePower), width = 0.1)+
    theme_bw()+
    geom_hline(yintercept=1.343, linetype='dotted', size = 0.8)+
    annotate("text", x =1.2, y = 1.343, label = "Mean Power Generated", vjust = -0.5, size = 3)
    theme(legend.position="none", )+
    xlab("Gait Phase")+
    ylab("Power Generated (J/Kg)")
    
    
```
This graph supports the results of the repeated measures of variance indicating there is a significant difference between the phases (p = 155.4 <2e-16). Therefore, gait phase does play a significant role in power generation while walking.


