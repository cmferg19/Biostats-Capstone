---
title: "Data_analysis_scratch"
author: "Cora Ferguson"
date: "2022-11-14"
output: html_document
---

# Overview
Given that last time we cleaned up the data to separate the variables that we are interested in out, now I am moving onto the data analysis phase.  I have three different hypothesis that I want to look at:

  1.	Hypothesis: Since the active prosthetic is designed to mimic the natural motion of the body, I believe the active prosthetic will have more propulsion while walking uphill than the passive prosthetic. 
  
  2.	Hypothesis: When walking downhill, the body absorbs force by dampening each step.  This allows humans to maintain a reasonable center of gravity while reducing the forces on other joints.  The active prosthetic is designed to increase energy return upon stepping up whereas the passive ankle is designed to absorb energy and transfer it forward.  While the energy that is transferred forward may not be as strong as in the active prosthetic, I expect the dampening effect of the passive prosthetic to be greater than the active prosthetic. 
  
  3.	Hypothesis: The next think that I want to look at is the effects of power generation in different parts of the stance on overall swing velocity.  Power generation refers to the amount of force that is used to push off of the ground.  In different stances, different muscles are involved in power generation which causes this force to vary.  I want to see which stance has the greatest impact on overall power generation.  The three stances I will analyze are the pre-swing, the midstance, and the terminal stance.  Of these, I believe that power generation will be the greatest in the midstance phase.
  
Before we get into actually analysing these datasets, we need to set up R so we have the libraries that we need and the environment is cleared.
```{r}
# clear R's environment
rm(list = ls())

# import the modules that we need
library(dplyr)
library(ggplot2)
library(tidyr)
library(ggfortify)
library(here)
```

Now we are going to import the data that we processed during the data exploration phase:
```{r}
DF <- read.csv(here("Data", "Processed", "processed_prosthetic_analysis.csv"))
```

# Data Analysis
Since the data is now in the program, we are going to start taking a look at the data analysis I want to perform.

## Comparing Propulsion between Prosthetic Types
For this test I would like to compare how the propulsion generated by the active prosthetic compares to the propulsion generated by the passive prosthetic. From the data exploration, it appears that there is a difference in the spread of the distribution between the two different types of prosthetic and the magnitude of the propulsion that they are able to generate.  

```{r}
# make a histogram of the Power_Gen_Terminal based on prosthetic type
ggplot(filter(DF, Side == "Prosthetic"), aes(x = Power_Gen_Terminal))+
    geom_histogram(binwidth = 0.25)+
    facet_wrap(~Session)
```

To do this, I will perform a two sample T test between the two prosthetic types.  

```{r}
# perform two sample t test
t.test(Propulsion ~ filter(DF, Side == "Prosthetic"), data = DF)
```
Yep, that did not work.  I first need to filter out the prosthetic data from the rest of the data.  To do that, I will use piping to create a new DF to use.
```{r}
# separate the prosthetic data from the data corresponding to the intact leg data.
DF_prosthetic <- DF %>% filter(Side == "Prosthetic")

# take a look to check this new data frame
glimpse(DF_prosthetic)
```
Ok now lets give the two sample t test another shot:
```{r}
# perform two sample t test
t.test(Propulsion ~ Session, data = DF_prosthetic)
```
Based on this, there is not a significant difference between the propulsion generated by the active and passive prostheses. Let's graph this in a way that models this relationship better.  I think a scatter plot might show it best.
```{r}
# make a scatter plot comparing the distribution of propulsion values between the active and passive prostheses
ggplot(DF_prosthetic, aes(Session, Propulsion, colour = Session))+
     xlab("Type of Prosthetic")+
     ylab("Propulsion (J/Kg)")+
     geom_jitter()+
     theme_bw()+
     theme(legend.position="none")
```

Great! Now we are going to move onto the next hypothesis.  Here we are trying to figure out how to compare the dampening effects of each of the different types of prostheses compared to the intact leg. 

## Comparing Dampening Between Prosthetic Types and The Intact Leg
To make this comparison, I am going to perform a two-way ANOVA. The goal is to compare the dampening performance between prostheses and intact legs and see if the type of prosthetic has an effect on dampening performance.

In this case, two of our variables are categorical - type of leg and type of prosthetic.  First let's convert these from factor to character data:

```{r}
# convert the Session and the Side categories to factor data and take a look at the variables
DF$Session <- as.factor(DF$Session)
DF$Side <- as.factor(DF$Side)

levels(DF$Session)
levels(DF$Side)
```

Now, lets take a look at the means of the combinations of each of these.  To do this, we will be using the `group_by()` and `summarize()` functions. 


```{r}
meanDF <- DF %>% group_by(Side, Session) %>% summarise(meanDampening = mean(Braking))
```
Now, we are going to plot the relationship between these different variables using the means of different combinations. 

```{r}
# create a scatter plot that is modeling the relationship between these
ggplot(meanDF, aes(Side, meanDampening))+
     geom_point()+
     theme_bw()

```
This graph does not tell us a whole lot so lets beef up the plot a little bit to make the differences and the relationships between them a little clearer. 

```{r}
# Add color to the plot to show the differences between the different types of prostheses compared to the intact leg
ggplot(meanDF, aes(Side, meanDampening, color = Session, group = Session))+
     geom_point()+
     geom_line()+
     theme_bw()
```
On this graph, it looks like the lines are not parallel which suggests that the type of prosthetic may impact the dampening compared to the intact leg.  Now that we have this plotted, we can create the ANOVA model. 

```{r}
# use the lm() function to create the model
model_dampening <- lm(Braking ~ Session*Side, data = DF)
```

Now check the assumptions using the `autoplot()` function.  The goal of this is to ensure that the data fit the normalized model that we are basing it off of

```{r}
autoplot(model_dampening, smooth.color = NA)
```
The first thing that we are going to look at is the Residuals vs Fitted graph.  Here, we are looking for the residuals to be distributed away from the curve at relatively equal distances.  From the graph generated using the `autoplot()` function, this appears to be the case.

The next thing that we are looking for is to see if the points fall along the linear model for the Normal Q-Q graph.  Here, it looks like they do which means that the data do fit a normalized distribution.  

Since the data passes both of these tests, we will proceed with this model and move on to taking a look a the model using the `anova()` function.  The `anova()` function does not actually perform an ANOVA test but it will give us a summary table of the relationships that we want to look at. 

```{r}
# generate ANOVA table
anova(model_dampening)
```
Based on this ANOVA table it looks like there is not a significant difference between the sides (intact vs prosthetic) but there is a significant difference in session which refers to the type of prosthetic used (BiOM vs ESR).  When the side and the types of prostheses are compared together however, there is not a significant difference between them (p = 0.3539)

```{r}
# take a look at the summary and comparisons between the specific conditions
summary.lm(model_dampening)
```
The intercept is a combination of levels from the different factors.  In this case, I believe that it is Intact-BiOM.  So is is using the mean of the intact leg while walking with the BiOM prosthetic as the baseline of comparison.  However, the results of this show that the slopes between these two comparisons are not great enough to warrant a significant difference.  Let's replot to take a closer look at this relationship:

```{r}
# first grab the standard error values to report

sumDF<-DF %>% group_by(Side, Session) %>% summarise(
     meanDamp = mean(Braking),
     seDamp = sd(Braking)/sqrt(sum(!is.na(Braking)))
)
```

Now we will incorporate these values into our plot to add error bars to the plot

```{r}
# create scatterplot with error bars
ggplot(sumDF, aes(Side, meanDamp, color = Session, group = Session))+
     geom_point()+
     geom_line()+
     geom_errorbar(aes(ymin = meanDamp - seDamp,
                       ymax = meanDamp + seDamp), width = 0.1)+
     theme_bw()+
    xlab("Type of Leg")+
    ylab("Mean Dampening (J/Kg)")
```
## Comparing the Power Generated in Different Stance Phases
The next thing that I am going to look at is the power generated in different phases of the stance.  To do this, I will perform a repeated measures analysis of variance test.  First I need to convert the data from a wide to long format. 

```{r}
# convert the data to long format
DF_long <- pivot_longer(DF, names_to = "Phase", cols = Power_Gen_Pre:Power_Gen_Terminal,  values_to = "Power")

# convert the phase data from character data to factor data
DF_long$Phase <- as.factor(DF_long$Phase)

levels(DF_long$Phase)
```

Now that the data are in a long format and categorized appropriately, we can move forward with the analysis. The first thing that I am going to do is relevel the factors to put them in the correct order.  

```{r}
# relevel the Phase factor to put the levels in the correct order which should be midstance, terminalstance, preswing
DF_long$Phase <- factor(DF_long$Phase, levels=c('Power_Gen_Mid', 'Power_Gen_Terminal', 'Power_Gen_Pre'))
```

Now, let's make a boxplot of the data to take a look at the relationships between these variables. 

```{r}
# make a boxplot of the data
ggplot(DF_long, aes(Phase, Power)) +
  geom_boxplot()+
  geom_point(size = 3, colour = 'lightgrey', alpha = 0.5)
```
From this, it looks like there is a difference in the power generated between the different phases.  Although it created this boxplot, I am a little confused as to why the levels are in the wrong level. 

Actually never mind, I just realized I forgot to specify the specific column.  I fixed this by using `DF_long$Phase <- refactoring code`. 

Now we are going to look at this at a deeper level using a repeated measures ANOVA analysis.  This is a good choice to compare the differences in power because repeated measures are commonly used to determine whether there is a statistically significant difference in the means of groups that have three or more categories with the same individuals partaking in each.

```{r}
# to do this I will use the aov() function to generate a model
#fit repeated measures ANOVA model
power_model <- aov(Power~factor(Phase)+Error(factor(Subject)), data = DF_long)
```

The model ran which is good. Now we are going to take a look at the  assumptions and the model summary.

```{r}
# check assumptions
autoplot(model_dampening, smooth.color = NA)
```
The assumptions look good.  The residuals are evenly distributed from the line and the points fit a normalized distribution of the data as shown by the Normal Q-Q line. 

```{r}
# run a summary of the model
summary(power_model)
```

In this case the null hypothesis is that all of the means of the groups are equal.  However, the P-value for this test indicates there is a significant difference between the means of the different gait phases.

Let's find a way to replot this in a way that shows the relationships between the different means better. This is a time-based set of data because it is based on gait phase. Because of this, I think a line plot would be a good way to model this. 

```{r}
# create scatterplot with lines to model this
ggplot(DF_long, aes(Phase, Power))+
     geom_point()+
     geom_line()+
     theme_bw()
```
This wasn't exactly what I was going for so first I think I need to calculate the means and standard error of these different values.

```{r}
# calculate the means and standard errors of these by group

sum_power <-DF_long %>% group_by(Phase) %>% summarise(
     meanPower = mean(Power),
     sePower = sd(Power)/sqrt(sum(!is.na(Power)))
)

# reassign the values of the different gait phases to make them show up nicer on the graph
sum_power$Phase <- recode(sum_power$Phase, Power_Gen_Mid = 'Midstance', 
                                       Power_Gen_Terminal = 'Terminal Stance',
                                       Power_Gen_Pre = 'Preswing')
```

Now let's give the line graph another shot:
```{r}
# create scatterplot with error bars
ggplot(sum_power, aes(Phase, meanPower, color = Phase))+
     geom_point()+
     geom_line()+
     geom_errorbar(aes(ymin = meanPower - sePower,
                       ymax = meanPower + sePower), width = 0.1)+
    theme_bw()+
    theme(legend.position="none")+
    xlab("Gait Phase")+
    ylab("Power Generated (J/Kg)")
    
```
Based on this graph you can clearly see that none of the error bars for any of the stance phases overlap which indicates there is a significant difference between each of those. This supports our findings that show that gait phase does play a significant role in power generation while walking.



