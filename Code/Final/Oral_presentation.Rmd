---
title: "Lower limb prosthetic gait analysis to identify factors contributing to long term adverse health outcomes in amputees"
author: "Cora Ferguson"
date: "2022-30-19"
output: html_document
---

```{r include=FALSE}
# clear R's environment
rm(list = ls())

# import the modules that we need
library(dplyr)
library(ggplot2)
library(tidyr)
library(ggfortify)
library(here)

# import the data
DF <- read.csv(here("Data", "Processed", "processed_prosthetic_analysis.csv"))
```

# Introduction
- In the Untied States, 1.9 million individuals are living with lower limb loss [1]
- factors that contribute to lower limb loss:
    - trauma, diabetes, peripheral artery disease [1][2]


# Prosthetic design
- Comfort, accessibility, function, and biomechanics
  - long term use impacts natural motion of body
  - contributes to adverse health outcomes such as chronic pain, arthritis, joint problems, and more [2]
  
  
  
## The two main types of models available today:
```{r img-knitr, echo=FALSE, fig.align='center', out.width='50%', fig.cap='Figure 1. A) An example of an active prosthetic limb.  The ankle has a microcontroller in it to adjust the degree of the ankle and increase the range of motion. B) An example of a passive prosthetic. These systems use a series of mechanisms and material properties to allow for movment.'}
knitr::include_graphics(here("Images", "Activevspassiveprostheses.png"))
``` 

#### Active Prosthetic Models
- Have microcontroller to adjust power, angle, etc.
- designed to mimic natural movement of body [3]

#### Passive Prosthetic Models
- Do not have microcontroller
- use material properties to for power and force absorption


<br>


# Goal: Analyse the differences between active and passive prosthetic models to investigate how these models may contribute to adverse health outcomes
 - Propulsion
 - Dampening
 - Power Generation



## Propulsion
```{r fig.align='center',echo = FALSE, fig.cap="Figure 2. Distribution of the propulsion data between the active (BioM) and passive (ESR) prosthetic models. "}
# make a histogram of the propulsion based on prosthetic type
ggplot(filter(DF, Side == "Prosthetic"), aes(x = Propulsion))+
  geom_histogram(binwidth = 0.05)+
  facet_wrap(~Session)+
  xlab("Propulsion (J/Kg)")+
  ylab("Number of Observations")
  
```

#### Two-Sample T Test:
```{r include=FALSE}
# separate the prosthetic data from the data corresponding to the intact leg data.
DF_prosthetic <- DF %>% filter(Side == "Prosthetic")
```

```{r echo = FALSE}
# perform two sample t test
t.test(Propulsion ~ Session, data = DF_prosthetic)
```

#### Results: 
- No significant difference between the propulsion generated by the active and passive prosthetic devices (p = 0.0125) 
- Propulsion force is similar between these two prosthetic models

```{r fig.align='center',echo = FALSE, fig.cap="Figure 3. The distribution of the propulsion generated between the BiOM (active) and ESR (passive) prosthetic models. The larger dots indicate the mean propulsion generated by the respective prosthetic models."}
# calculate the means propulsion values
meanpropDF<-DF_prosthetic %>% group_by(Session) %>% summarise(
     meanProp = mean(Propulsion),
     sePropulsion = sd(Propulsion)/sqrt(sum(!is.na(Propulsion))))

# make a scatter plot comparing the distribution of propulsion values between the active and passive prostheses
propscatter <- ggplot(DF_prosthetic, aes(Session, Propulsion, colour = Session), size = 3, alpha = 0.5)+
  xlab("Type of Prosthetic")+
  ylab("Propulsion (J/Kg)")+
  geom_jitter(width = 0.1)+
  theme_bw()+
  theme(legend.position="none")

propscatter+
geom_point(meanpropDF, mapping = aes(Session, meanProp), size = 4, alpha = 1)
```

## Dampening


#### Preliminary Data Modeling
```{r include=FALSE}
# convert the Session and the Side categories to factor data and take a look at the variables
DF$Session <- as.factor(DF$Session)
DF$Side <- as.factor(DF$Side)

# calculate the means of the combinations of different factors
meanDF <- DF %>% group_by(Side, Session) %>% summarise(meanDampening = mean(Braking))
```
```{r fig.align='center',echo = FALSE, fig.cap="Figure 4. Side-by-side comparison of the mean dampening power of the intact leg compared to the prosthetic legs and seperated by prosthetic type."}
# Plot this to show the differences between the different types of prostheses compared to the intact leg
ggplot(meanDF, aes(Side, meanDampening, color = Session, group = Session))+
     geom_point()+
     geom_line()+
     theme_bw()+
     ylab("Mean Dampening (J/Kg)")+
     xlab("Type of Leg")
```

#### Two-Way ANOVA:
```{r fig.align='center', fig.cap="Figure 5. The results of the 'autoplot()' function used to check the assumptions of the two way ANOVA.  The *Residuals vs Fitted* graph on the top left represents the graph of the residuals as they fit the model. The *Normal Q-Q* graph on the top left represents how well the points fit a normalized distribution."}
# create the model using the lm() function
model_dampening <- lm(Braking ~ Session+Side+Session*Side, data = DF)

# check assumptions
autoplot(model_dampening, smooth.color = NA)
```

```{r echo = FALSE}
# generate ANOVA table
anova(model_dampening)
```
```{r fig.align='center', echo = FALSE}
# take a look at the summary and comparisons between the specific conditions
summary.lm(model_dampening)
```
#### Results
- No significant difference between the dampening effects of the intact leg compared to the prosthetic leg (p = 0.8432).  
- Significant difference in dampening between the active and passive prosthetic models (p = 0.0237).  
- No significant in dampening associated with the intact leg with the different prosthetic models (p = 0.3539).
- The slopes between these two comparisons are insignificant
   - The dampening effects of the intact leg does not differ depending on the type of prosthetic
```{r include=FALSE}
# grab the standard error values to report

sumDF<-DF %>% group_by(Side, Session) %>% summarise(
     meanDamp = mean(Braking),
     seDamp = sd(Braking)/sqrt(sum(!is.na(Braking)))
)
```

```{r fig.align='center', echo = FALSE, fig.cap="Figure 6. The mean dampening power of the intact leg while walking with the BiOM prosthetic model (-0.179 ± 0.023). The mean dampening of the intact leg while walking with the ESR prosthetic model(-0.154 ± 0.009). These values are compared to the mean dampening power of the BiOM(-0.192 ± 0.023) and ESR(-0.134 ± 0.009) prosthetic models."}
# create scatterplot with error bars
ggplot(sumDF, aes(Side, meanDamp, color = Session, group = Session))+
     geom_point()+
     geom_line()+
     geom_errorbar(aes(ymin = meanDamp - seDamp,
                       ymax = meanDamp + seDamp), width = 0.1)+
     theme_bw()+
    xlab("Type of Leg")+
    ylab("Mean Dampening (J/Kg)")
```

## Power Generation During Gait Phase
```{r img-with-knitr, echo=FALSE, fig.align='center', out.width='50%', fig.cap='Figure 7. The three different stances that produce the most amount of stress on the residual limb.  The orange labeled legs mark the position of the prosthetic in each of these phases.'}
knitr::include_graphics(here("Images", "Gaitdiagram.png"))
``` 

- Gait phase correlates to the loading response of the prosthetic.  
- When an individual is loading or putting weight on the prosthetic, they are also increasing the stress on their residual limb.  
- Because these phases are the highest stress, they also are the phases that are most likely to contribute to injury and/or long term pain.

```{r include=FALSE}
# convert the data to long format
DF_long <- pivot_longer(DF, names_to = "Phase", cols = Power_Gen_Pre:Power_Gen_Terminal,  values_to = "Power")

# convert the phase data from character data to factor data
DF_long$Phase <- as.factor(DF_long$Phase)
levels(DF_long$Phase)

# relevel the Phase factor to put the levels in the correct order which should be midstance, terminal stance, preswing
DF_long$Phase <- factor(DF_long$Phase, levels=c('Power_Gen_Mid', 'Power_Gen_Terminal', 'Power_Gen_Pre'))

# reassign the values of the different gait phases to make them show up nicer on the graph
DF_long$Phase <- recode(DF_long$Phase, Power_Gen_Mid = 'Midstance', Power_Gen_Terminal = 'Terminal Stance', Power_Gen_Pre = 'Preswing')
```


```{r fig.align='center', echo = FALSE, fig.cap="Figure 8. A histogram of the spread of the power generated seperated by gait phase."}
# make a histogram of the power generated separated by phase
ggplot(DF_long, aes(x = Power))+
    geom_histogram(binwidth = 0.25)+
    facet_wrap(~Phase)
```

#### Repeated Measures ANOVA
```{r fig.align='center'}
# Use the aov() function to generate a repeated ANOVA model
power_model <- aov(Power~factor(Phase), data = DF_long)

# check assumptions
autoplot(power_model, smooth.color = NA)
```

```{r, echo = FALSE}
# run a summary of the model
summary(power_model)
```
#### Results:
- There is a signficant difference between the power gerneated in each of the phases

```{r echo=FALSE}
# calculate the means and standard errors of these by group

sum_power <-DF_long %>% group_by(Phase) %>% summarise(
     meanPower = mean(Power),
     sePower = sd(Power)/sqrt(sum(!is.na(Power)))
)
```
```{r fig.align='center', echo=FALSE, fig.cap="Figure 9. The mean ± standard error of the power generated in the mid stance (-0.41775 ± 0.0499), the terminal stance (0.84425 ± 0.0753), and the preswing (3.6033 ± 0.2789)."}
# create scatterplot with error bars
ggplot(sum_power, aes(Phase, meanPower, color = Phase))+
     geom_point(size = 2)+
     scale_color_manual(values = c("Midstance" = "Magenta",
                                "Terminal Stance" = "Blue",
                                "Preswing"="Dark Green"))+
     geom_line()+
     geom_errorbar(aes(ymin = meanPower - sePower,
                       ymax = meanPower + sePower), width = 0.2, linewidth = 0.4)+
    theme_bw()+
    theme(legend.position = "none")+
    geom_hline(yintercept=1.343, linetype='dotted', linewidth = 0.8)+
    annotate("text", x =1.2, y = 1.343, label = "Mean Power Generated", vjust = -0.5, size = 3)+
    xlab("Gait Phase")+
    ylab("Power Generated (J/Kg)")
    
    
```

# Biological Summary
The goal of this analysis was to identify potential contributing factors to long term adverse health outcomes in below the knee amputees.  To do this, different factors like propulsion, dampening, and power generation during different gait phases were investigated.  

Between the active and passive prosthetic models, there is no significant difference in propulsion (p-value = 0.01246).  Though the active prosthetic model has a microcontroller in it which allows for live power adjustments, it is still comparable to the passive prosthetic which does not have a microcontroller. Despite this, it is worth noting that the propulsion values associated with the active prosthetic were generally slightly higher than the propulsion achieved with the passive prosthetic. Future studies could look at different models of passive and active prostheses to investigate whether this result is exclusive to the BioM and ESR models that were used in this study or not.

The dampening analysis revealed that the dampening effect of the passive prosthetic was a significantly higher than the active prosthetic (p-value = 0.0237).  Biologically, this means that the type of prosthetic plays a significant role in degree of excess stress placed on the residual limb due to the lack of dampening[5]. Prosthetic models with less dampening are reported to be less comfortable and cause more pain for amputees.  Physiologically, this pain causes extra strain on the rest of the body as individuals try to compensate which increases one's risk for adverse health outcomes[4][5].

Such devices could be inspired by looking further into the power generated during different gait phases and adapting the prosthetic to better absorb shock during the midstance phase.  There is a significant difference between the power generated in each of these positions and this could be used to inspire the design of devices that are able to better absorb the power generated in each of these phases (p-value = $2.0 \times 10^{-16}$). 


# Challenges
One challenges I ran into with this project included interpreting the results of the two-way ANOVA that I ran to compare dampening between the different variables.  Even though we talked about how the `anova()` function and `summary()` functions report data, it was confusing to try and interpret how it compared the factors and levels that I wanted it to compare.  

Another challenge I ran into was figuring out how to run a repeated measures ANOVA.  I ended up doing a lot of searching on the internet to figure out the most efficient way to do this but I believe I got it.  The benefit of the repeated measures ANOVA over a regular one-way or two-way ANOVA is that it takes data that happens in a specific order and compares values in and between the different levels to provide a better comparison for ordered categorical data.  

Lastly, I ran into a few weird problems like not being able to import the `tidyverse` package, `dplyr` stopped working, and the `autoplot()` function being finicky.  For each of these, I did some extensive troubleshooting and while I couldn't figure out the tidyverse issue, I was able to get `dplyr` to work after uninstalling and reinstalling a bunch of packages that it is dependent on.  


# References
[1] Balk EM, Gazula A, Markozannes G, et al. Lower Limb Prostheses: Measurement Instruments, Comparison of Component Effects by Subgroups, and Long-Term Outcomes [Internet]. Rockville (MD): Agency for Healthcare Research and Quality (US); 2018 Sep. (Comparative Effectiveness Review, No. 213.) Evidence Summary. Available from: https://www.ncbi.nlm.nih.gov/books/NBK531527/

[2] Dillingham, Timothy R. MD, MS; Pezzin, Liliana E. PhD; MacKenzie, Ellen J. PhD; Burgess, Andrew R. MD. Use and Satisfaction with Prosthetic Devices Among Persons with Trauma-Related Amputations: A Long-Term Outcome Study. American Journal of Physical Medicine & Rehabilitation: August 2001 - Volume 80 - Issue 8 - p 563-571 

[3] Childers, W. L., & Takahashi, K. Z. (2018). Increasing prosthetic foot energy return affects whole-body mechanics during walking on level ground and slopes. Scientific Reports 2018 8:1, 8(1), 1–12. https://doi.org/10.1038/s41598-018-23705-8

[4] Nickel, E., & Sensinger, J. (2014). Passive prosthetic ankle-foot mechanism for automatic adaptation to sloped surfaces Motor control in upper limb prostheses View project Series Elastic Actuators for Prosthetic Components View project. Article in The Journal of Rehabilitation Research and Development. https://doi.org/10.1682/JRRD.2013.08.0177

[5] Safaeepour, Z., Eshraghi, A., &#38; Geil, M. (2017). The effect of damping in prosthetic ankle and knee joints on the biomechanical outcomes: A literature review. <i>Prosthetics and Orthotics International</i>, <i>41</i>(4), 336–344. https://doi.org/10.1177/0309364616677651/ASSET/IMAGES/LARGE/10.1177_0309364616677651-FIG1.JPEG</div>

