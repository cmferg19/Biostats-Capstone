---
title: "Lower limb prosthetic gait analysis to identify factors contributing to long term adverse health outcomes in amputees"
author: "Cora Ferguson"
date: "2022-30-19"
output: html_document
---

```{r include=FALSE}
# clear R's environment
rm(list = ls())

# import the modules that we need
library(dplyr)
library(ggplot2)
library(tidyr)
library(ggfortify)
library(here)

# import the data
DF <- read.csv(here("Data", "Processed", "processed_prosthetic_analysis.csv"))
```

# The Data:
- From a study performed by the Department of Rehabilitation Medicine at the Brooke Army Medical Center in Houston, Texas[1]
- Goal of the study was to evaluate the biomechanical compensations of lower limb amputees when using different types of prosthetic limbs on a sloped surface
  - Over time, these compensations can create additional wear and stress on joints that cause long term health outcomes


### Prosthetic design
- Comfort, accessibility, function, and biomechanics
  - long term use impacts natural motion of body
  - contributes to adverse health outcomes such as chronic pain, arthritis, joint problems, and more [2]
  
  
  
### The two main types of models available today
```{r img-knitr, echo=FALSE, fig.align='center', out.width='60%'}
knitr::include_graphics(here("Images", "Activevspassiveprostheses.png"))
``` 

#### **Active Prosthetic Models**
- Have microcontroller to adjust power, angle, etc.
- designed to mimic natural movement of body [3]

#### **Passive Prosthetic Models**
- Do not have microcontroller
- use material properties to for power and force absorption


<br>


# Goal: Analyse the differences between active and passive prosthetic models to investigate how these models may contribute to adverse health outcomes

## Data Processing:
```{r img-knitr-b, echo=FALSE, fig.align='center', out.width='99%'}
knitr::include_graphics(here("Images", "dataworkflow.png"))
``` 

<br>
```{r img-knitr-a, echo=FALSE, fig.align='center', out.width='80%'}
knitr::include_graphics(here("Images", "variablesbreakdown.png"))
``` 

<br>

## Hypothesis 1: Propulsion
Since the active prosthetic is able to generate push off power using a motor, it will generate a greater amount of propulsion than the passive prosthetic.

#### Preliminary data modeling:
```{r fig.align='center',echo = FALSE, out.width='80%'}
# make a histogram of the propulsion based on prosthetic type
ggplot(filter(DF, Side == "Prosthetic"), aes(x = Propulsion))+
  geom_histogram(binwidth = 0.05)+
  facet_wrap(~Session)+
  xlab("Propulsion (J/Kg)")+
  ylab("Number of Observations")
  
```
- Based on this, I do not beleive there will be a significant difference in propulsion force between the BiOM (active) and ESR (passive) prosthetic models

#### Two-Sample T Test:
```{r include=FALSE}
# separate the prosthetic data from the data corresponding to the intact leg data.
DF_prosthetic <- DF %>% filter(Side == "Prosthetic")
```

```{r echo = FALSE, out.width='80%'}
# perform two sample t test
t.test(Propulsion ~ Session, data = DF_prosthetic)
```

#### Results: 
- Significant difference present between the propulsion generated by the active and passive prosthetic devices (p = 0.0125) 

```{r fig.align='center',echo = FALSE, out.width='80%'}
# calculate the means propulsion values
meanpropDF<-DF_prosthetic %>% group_by(Session) %>% summarise(
     meanProp = mean(Propulsion),
     sePropulsion = sd(Propulsion)/sqrt(sum(!is.na(Propulsion))))

# make a scatter plot comparing the distribution of propulsion values between the active and passive prostheses
propscatter <- ggplot(DF_prosthetic, aes(Session, Propulsion, colour = Session), size = 3, alpha = 0.5)+
  xlab("Type of Prosthetic")+
  ylab("Propulsion (J/Kg)")+
  geom_jitter(width = 0.1)+
  theme_bw()+
  theme(legend.position="none")

propscatter+
geom_point(meanpropDF, mapping = aes(Session, meanProp), size = 4, alpha = 1)
```

## Hypothesis 2: Dampening
I believe the passive prosthetic will be more efficient at dampening because the materials are designed to absorb the energy of impact and convert that into force that is then used to propel the individual off the ground. The active prosthetic has more mechanical parts which interfere with the initial energy absorption phase.

#### Preliminary data modeling:
```{r include=FALSE}
# convert the Session and the Side categories to factor data and take a look at the variables
DF$Session <- as.factor(DF$Session)
DF$Side <- as.factor(DF$Side)

# calculate the means of the combinations of different factors
meanDF <- DF %>% group_by(Side, Session) %>% summarise(meanDampening = mean(Braking))
```

```{r fig.align='center',echo = FALSE, out.width='80%'}
# Plot this to show the differences between the different types of prostheses compared to the intact leg
ggplot(meanDF, aes(Side, meanDampening, color = Session, group = Session))+
     geom_point()+
     geom_line()+
     theme_bw()+
     ylab("Mean Dampening (J/Kg)")+
     xlab("Type of Leg")
```

#### Two-Way ANOVA:
```{r fig.align='center', out.width='80%'}
# create the model using the lm() function
model_dampening <- lm(Braking ~ Session+Side+Session*Side, data = DF)

# check assumptions
autoplot(model_dampening, smooth.color = NA)
```

```{r echo = FALSE, out.width='80%'}
# generate ANOVA table
anova(model_dampening)
```
```{r fig.align='center', include = FALSE, out.width='80%'}
# take a look at the summary and comparisons between the specific conditions
summary.lm(model_dampening)
```
#### Results:
- No significant difference between the dampening effects of the intact leg compared to the prosthetic leg (p = 0.8432).  
- Significant difference in dampening between the active and passive prosthetic models (p = 0.0237).  
- No significant in dampening associated with the intact legs while walking with the different types of prostheses (p = 0.3539).
- The slopes between these two comparisons are insignificant
   - The dampening effects of the intact leg does not differ depending on the type of prosthetic
```{r include=FALSE}
# grab the standard error values to report

sumDF<-DF %>% group_by(Side, Session) %>% summarise(
     meanDamp = mean(Braking),
     seDamp = sd(Braking)/sqrt(sum(!is.na(Braking)))
)
```

```{r fig.align='center', echo = FALSE, out.width='80%'}
# create scatterplot with error bars
ggplot(sumDF, aes(Side, meanDamp, color = Session, group = Session))+
     geom_point()+
     geom_line()+
     geom_errorbar(aes(ymin = meanDamp - seDamp,
                       ymax = meanDamp + seDamp), width = 0.1)+
     theme_bw()+
    xlab("Type of Leg")+
    ylab("Mean Dampening (J/Kg)")+
  annotate("text", x = 2.4 , y = -0.22,
    label = "n = 12")
```

## Hypothesis 3:Power Generation During Gait Phase
I beleive that there will be a significant difference in power generation between the three phases because each phase has a different purpose in the gait cycle
```{r img-with-knitr, echo=FALSE, fig.align='center', out.width='50%'}
knitr::include_graphics(here("Images", "Gaitdiagram.png"))
``` 

- Gait phase correlates to the loading response of the prosthetic.  
- Because these phases are the highest stress, they also are the phases that are most likely to contribute to injury and/or long term pain

#### Preliminary data modeling:
```{r include=FALSE}
# convert the data to long format
DF_long <- pivot_longer(DF, names_to = "Phase", cols = Power_Gen_Pre:Power_Gen_Terminal,  values_to = "Power")

# convert the phase data from character data to factor data
DF_long$Phase <- as.factor(DF_long$Phase)
levels(DF_long$Phase)

# relevel the Phase factor to put the levels in the correct order which should be midstance, terminal stance, preswing
DF_long$Phase <- factor(DF_long$Phase, levels=c('Power_Gen_Mid', 'Power_Gen_Terminal', 'Power_Gen_Pre'))

# reassign the values of the different gait phases to make them show up nicer on the graph
DF_long$Phase <- recode(DF_long$Phase, Power_Gen_Mid = 'Midstance', Power_Gen_Terminal = 'Terminal Stance', Power_Gen_Pre = 'Preswing')
```


```{r fig.align='center', echo = FALSE, out.width='80%'}
# make a histogram of the power generated separated by phase
ggplot(DF_long, aes(x = Power))+
    geom_histogram(binwidth = 0.25)+
    facet_wrap(~Phase)
```

#### Repeated Measures ANOVA:
```{r fig.align='center', out.width='80%'}
# Use the aov() function to generate a repeated ANOVA model
power_model <- glm(Power~factor(Phase), data = DF_long)

# check assumptions
autoplot(power_model, smooth.color = NA)
```

```{r, echo = FALSE, out.width='80%'}
# run a summary of the model
summary(power_model)
```
#### Results:
- There is a significant difference between the Terminal stance and the midstance (p = 6e-07)
- There is a significant difference between the Pre Swing and the midstance (p = 2e-16)

```{r echo=FALSE}
# calculate the means and standard errors of these by group

sum_power <-DF_long %>% group_by(Phase) %>% summarise(
     meanPower = mean(Power),
     sePower = sd(Power)/sqrt(sum(!is.na(Power)))
)
```
```{r fig.align='center', echo=FALSE, message = FALSE, out.width='80%'}
# create scatterplot with error bars
ggplot(sum_power, aes(Phase, meanPower, color = Phase))+
     geom_point(size = 2)+
     scale_color_manual(values = c("Midstance" = "Magenta",
                                "Terminal Stance" = "Blue",
                                "Preswing"="Dark Green"))+
     geom_line()+
     geom_errorbar(aes(ymin = meanPower - sePower,
                       ymax = meanPower + sePower), width = 0.2, linewidth = 0.4)+
    theme_bw()+
    theme(legend.position = "none")+
    geom_hline(yintercept=1.343, linetype='dotted', linewidth = 0.8)+
    annotate("text", x =1.2, y = 1.343, label = "Mean Power Generated", vjust = -0.5, size = 3)+
    xlab("Gait Phase")+
    ylab("Power Generated (J/Kg)")
    
    
```


# Take-Home Messages:
- Patience and persistence are key
- Keeping a good log of your data and format it well at the start of the data collection process to save future you a LOT of time
- *StackExchange* is your friend :)

# References
[1] Balk EM, Gazula A, Markozannes G, et al. Lower Limb Prostheses: Measurement Instruments, Comparison of Component Effects by Subgroups, and Long-Term Outcomes [Internet]. Rockville (MD): Agency for Healthcare Research and Quality (US); 2018 Sep. (Comparative Effectiveness Review, No. 213.) Evidence Summary. Available from: https://www.ncbi.nlm.nih.gov/books/NBK531527/

[2] Dillingham, Timothy R. MD, MS; Pezzin, Liliana E. PhD; MacKenzie, Ellen J. PhD; Burgess, Andrew R. MD. Use and Satisfaction with Prosthetic Devices Among Persons with Trauma-Related Amputations: A Long-Term Outcome Study. American Journal of Physical Medicine & Rehabilitation: August 2001 - Volume 80 - Issue 8 - p 563-571 

[3] Childers, W. L., & Takahashi, K. Z. (2018). Increasing prosthetic foot energy return affects whole-body mechanics during walking on level ground and slopes. Scientific Reports 2018 8:1, 8(1), 1–12. https://doi.org/10.1038/s41598-018-23705-8

[4] Nickel, E., & Sensinger, J. (2014). Passive prosthetic ankle-foot mechanism for automatic adaptation to sloped surfaces Motor control in upper limb prostheses View project Series Elastic Actuators for Prosthetic Components View project. Article in The Journal of Rehabilitation Research and Development. https://doi.org/10.1682/JRRD.2013.08.0177

[5] Safaeepour, Z., Eshraghi, A., &#38; Geil, M. (2017). The effect of damping in prosthetic ankle and knee joints on the biomechanical outcomes: A literature review. <i>Prosthetics and Orthotics International</i>, <i>41</i>(4), 336–344. https://doi.org/10.1177/0309364616677651/ASSET/IMAGES/LARGE/10.1177_0309364616677651-FIG1.JPEG</div>

